if(void 0===window.jQuery)throw new Error("The jQuery library is not loaded! The October CMS framework cannot be initialized.");if(void 0!==window.jQuery.request)throw new Error("The October CMS framework is already loaded!");!function($){"use strict";var Request=function(element,handler,options){var $el=this.$el=$(element);if(this.options=options||{},void 0===handler)throw new Error("The request handler name is not specified.");if(!handler.match(/^(?:\w+\:{2})?on*/))throw new Error('Invalid handler name. The correct handler name format is: "onEvent".');var context={handler:handler,options:options};$el.trigger("ajaxSetup",[context]);var $form=options.form?$(options.form):$el.closest("form"),$triggerEl=$form.length?$form:$el;if(void 0!==options.browserValidate&&"function"==typeof document.createElement("input").reportValidity&&$form.length&&!$form.get(0).checkValidity())return $form.get(0).reportValidity(),!1;var _event=jQuery.Event("oc.beforeRequest");if($triggerEl.trigger(_event,context),!_event.isDefaultPrevented()){var loading=void 0!==options.loading?options.loading:null,url=void 0!==options.url?options.url:window.location.href,isRedirect=void 0!==options.redirect&&options.redirect.length,useFlash=void 0!==options.flash,useFiles=void 0!==options.files;useFiles&&"undefined"==typeof FormData&&(console.warn("This browser does not support file uploads via FormData"),useFiles=!1),"string"==$.type(loading)&&(loading=$(loading));var requestHeaders={"X-OCTOBER-REQUEST-HANDLER":handler,"X-OCTOBER-REQUEST-PARTIALS":this.extractPartials(options.update)};useFlash&&(requestHeaders["X-OCTOBER-REQUEST-FLASH"]=1);var csrfToken=function(){var cookieValue=null;if(document.cookie&&""!=document.cookie)for(var cookies=document.cookie.split(";"),i=0;i<cookies.length;i++){var cookie=jQuery.trim(cookies[i]);if("XSRF-TOKEN="==cookie.substring(0,11)){cookieValue=decodeURIComponent(cookie.substring(11));break}}return cookieValue}();csrfToken&&(requestHeaders["X-XSRF-TOKEN"]=csrfToken);var requestData,inputName,data={};$.each($el.parents("[data-request-data]").toArray().reverse(),(function(){$.extend(data,paramToObj("data-request-data",$(this).data("request-data")))})),$el.is(":input")&&!$form.length&&void 0!==(inputName=$el.attr("name"))&&void 0===options.data[inputName]&&(options.data[inputName]=$el.val()),void 0===options.data||$.isEmptyObject(options.data)||$.extend(data,options.data),useFiles?(requestData=new FormData($form.length?$form.get(0):void 0),$el.is(":file")&&inputName&&($.each($el.prop("files"),(function(){requestData.append(inputName,this)})),delete data[inputName]),$.each(data,(function(key){requestData.append(key,this)}))):requestData=[$form.serialize(),$.param(data)].filter(Boolean).join("&");var requestOptions={url:url,crossDomain:!1,global:options.ajaxGlobal,context:context,headers:requestHeaders,success:function(data,textStatus,jqXHR){if(!1!==options.beforeUpdate.apply(context,[data,textStatus,jqXHR])&&(!options.evalBeforeUpdate||!1!==$.proxy(new Function("data",options.evalBeforeUpdate),$el.get(0))(data))){var _event=jQuery.Event("ajaxBeforeUpdate");if($triggerEl.trigger(_event,[context,data,textStatus,jqXHR]),!_event.isDefaultPrevented()){useFlash&&data.X_OCTOBER_FLASH_MESSAGES&&$.each(data.X_OCTOBER_FLASH_MESSAGES,(function(type,message){requestOptions.handleFlashMessage(message,type)}));var updatePromise=requestOptions.handleUpdateResponse(data,textStatus,jqXHR);return updatePromise.done((function(){$triggerEl.trigger("ajaxSuccess",[context,data,textStatus,jqXHR]),options.evalSuccess&&$.proxy(new Function("data",options.evalSuccess),$el.get(0))(data),options.afterUpdate.apply(context,[data,textStatus,jqXHR])})),updatePromise}}},error:function(jqXHR,textStatus,errorThrown){var errorMsg,data={},updatePromise=$.Deferred();if(!(void 0!==window.ocUnloading&&window.ocUnloading||"abort"==errorThrown))return isRedirect=!1,options.redirect=null,406==jqXHR.status&&jqXHR.responseJSON?(data=jqXHR.responseJSON,errorMsg=jqXHR.responseJSON.X_OCTOBER_ERROR_MESSAGE,updatePromise=requestOptions.handleUpdateResponse(data,textStatus,jqXHR)):(errorMsg=jqXHR.responseText?jqXHR.responseText:jqXHR.statusText,updatePromise.resolve()),updatePromise.done((function(){$el.data("error-message",errorMsg);var _event=jQuery.Event("ajaxError");$triggerEl.trigger(_event,[context,errorMsg,textStatus,jqXHR]),_event.isDefaultPrevented()||options.evalError&&!1===$.proxy(new Function("data",options.evalError),$el.get(0))(data)||requestOptions.handleErrorMessage(errorMsg)})),updatePromise},complete:function(data,textStatus,jqXHR){$triggerEl.trigger("ajaxComplete",[context,data,textStatus,jqXHR]),options.evalComplete&&$.proxy(new Function("data",options.evalComplete),$el.get(0))(data)},handleConfirmMessage:function(message){var _event=jQuery.Event("ajaxConfirmMessage");return _event.promise=$.Deferred(),void 0!==$(window).triggerHandler(_event,[message])?(_event.promise.done((function(){options.confirm=null,new Request(element,handler,options)})),!1):_event.isDefaultPrevented()?void 0:message?confirm(message):void 0},handleErrorMessage:function(message){var _event=jQuery.Event("ajaxErrorMessage");$(window).trigger(_event,[message]),_event.isDefaultPrevented()||message&&alert(message)},handleValidationMessage:function(message,fields){$triggerEl.trigger("ajaxValidation",[context,message,fields]);var isFirstInvalidField=!0;$.each(fields,(function(fieldName,fieldMessages){var fieldNameRaw=fieldName.replace(/\.(\w+)/g,"[$1]"),fieldNameArr=("."+fieldName).replace(/\.(\w+)/g,"[$1]"),fieldNameOptions=['[name="'+fieldNameRaw+'"]','[name="'+fieldNameRaw+'[]"]','[name$="'+fieldNameArr+'"]','[name$="'+fieldNameArr+'[]"]'],fieldElement=$form.find(fieldNameOptions.join(", ")).filter(":enabled").first();if(fieldElement.length>0){var _event=jQuery.Event("ajaxInvalidField");$(window).trigger(_event,[fieldElement.get(0),fieldName,fieldMessages,isFirstInvalidField]),isFirstInvalidField&&(_event.isDefaultPrevented()||fieldElement.focus(),isFirstInvalidField=!1)}}))},handleFlashMessage:function(message,type){},handleRedirectResponse:function(url){window.location.assign(url),$el.trigger("ajaxRedirect")},handleUpdateResponse:function(data,textStatus,jqXHR){var updatePromise=$.Deferred().done((function(){for(var partial in data){var selector=options.update[partial]?options.update[partial]:partial;"string"==$.type(selector)&&"!"==selector.charAt(0)?$(selector.substring(1)).replaceWith(data[partial]).trigger("ajaxUpdate",[context,data,textStatus,jqXHR]):"string"==$.type(selector)&&"@"==selector.charAt(0)?$(selector.substring(1)).append(data[partial]).trigger("ajaxUpdate",[context,data,textStatus,jqXHR]):"string"==$.type(selector)&&"^"==selector.charAt(0)?$(selector.substring(1)).prepend(data[partial]).trigger("ajaxUpdate",[context,data,textStatus,jqXHR]):($(selector).trigger("ajaxBeforeReplace"),$(selector).html(data[partial]).trigger("ajaxUpdate",[context,data,textStatus,jqXHR]))}setTimeout((function(){$(window).trigger("ajaxUpdateComplete",[context,data,textStatus,jqXHR]).trigger("resize")}),0)}));return data.X_OCTOBER_REDIRECT&&(options.redirect=data.X_OCTOBER_REDIRECT,isRedirect=!0),isRedirect&&requestOptions.handleRedirectResponse(options.redirect),data.X_OCTOBER_ERROR_FIELDS&&requestOptions.handleValidationMessage(data.X_OCTOBER_ERROR_MESSAGE,data.X_OCTOBER_ERROR_FIELDS),data.X_OCTOBER_ASSETS?assetManager.load(data.X_OCTOBER_ASSETS,$.proxy(updatePromise.resolve,updatePromise)):updatePromise.resolve(),updatePromise}};if(useFiles&&(requestOptions.processData=requestOptions.contentType=!1),context.success=requestOptions.success,context.error=requestOptions.error,context.complete=requestOptions.complete,(requestOptions=$.extend(requestOptions,options)).data=requestData,!options.confirm||requestOptions.handleConfirmMessage(options.confirm))return loading&&loading.show(),$(window).trigger("ajaxBeforeSend",[context]),$el.trigger("ajaxPromise",[context]),$.ajax(requestOptions).fail((function(jqXHR,textStatus,errorThrown){isRedirect||$el.trigger("ajaxFail",[context,textStatus,jqXHR]),loading&&loading.hide()})).done((function(data,textStatus,jqXHR){isRedirect||$el.trigger("ajaxDone",[context,data,textStatus,jqXHR]),loading&&loading.hide()})).always((function(dataOrXhr,textStatus,xhrOrError){$el.trigger("ajaxAlways",[context,dataOrXhr,textStatus,xhrOrError])}))}};Request.DEFAULTS={update:{},type:"POST",beforeUpdate:function(data,textStatus,jqXHR){},afterUpdate:function(data,textStatus,jqXHR){},evalBeforeUpdate:null,evalSuccess:null,evalError:null,evalComplete:null,ajaxGlobal:!1},Request.prototype.extractPartials=function(update){var result=[];for(var partial in update)result.push(partial);return result.join("&")};var old=$.fn.request;function paramToObj(name,value){if(void 0===value&&(value=""),"object"==typeof value)return value;try{return ocJSON("{"+value+"}")}catch(e){throw new Error("Error parsing the "+name+" attribute value. "+e)}}$.fn.request=function(handler,option){var $this=$(this).first(),data={evalBeforeUpdate:$this.data("request-before-update"),evalSuccess:$this.data("request-success"),evalError:$this.data("request-error"),evalComplete:$this.data("request-complete"),ajaxGlobal:$this.data("request-ajax-global"),confirm:$this.data("request-confirm"),redirect:$this.data("request-redirect"),loading:$this.data("request-loading"),flash:$this.data("request-flash"),files:$this.data("request-files"),browserValidate:$this.data("browser-validate"),form:$this.data("request-form"),url:$this.data("request-url"),update:paramToObj("data-request-update",$this.data("request-update")),data:paramToObj("data-request-data",$this.data("request-data"))};handler||(handler=$this.data("request"));var options=$.extend(!0,{},Request.DEFAULTS,data,"object"==typeof option&&option);return new Request($this,handler,options)},$.fn.request.Constructor=Request,$.request=function(handler,option){return $(document).request(handler,option)},$.fn.request.noConflict=function(){return $.fn.request=old,this},$(document).on("change","select[data-request], input[type=radio][data-request], input[type=checkbox][data-request], input[type=file][data-request]",(function(){$(this).request()})),$(document).on("click","a[data-request], button[data-request], input[type=button][data-request], input[type=submit][data-request]",(function(e){if(e.preventDefault(),$(this).request(),$(this).is("[type=submit]"))return!1})),$(document).on("keydown","input[type=text][data-request], input[type=submit][data-request], input[type=password][data-request]",(function(e){if("Enter"===e.key)return void 0!==this.dataTrackInputTimer&&window.clearTimeout(this.dataTrackInputTimer),$(this).request(),!1})),$(document).on("input","input[data-request][data-track-input]",(function(e){var $el=$(this),lastValue=$el.data("oc.lastvalue");if($el.is("[type=email],[type=number],[type=password],[type=search],[type=text]")&&(void 0===lastValue||lastValue!=this.value)){$el.data("oc.lastvalue",this.value),void 0!==this.dataTrackInputTimer&&window.clearTimeout(this.dataTrackInputTimer);var interval=$(this).data("track-input");interval||(interval=300);var self=this;this.dataTrackInputTimer=window.setTimeout((function(){self.lastDataTrackInputRequest&&self.lastDataTrackInputRequest.abort(),self.lastDataTrackInputRequest=$(self).request()}),interval)}})),$(document).on("submit","[data-request]",(function(){return $(this).request(),!1})),window.onbeforeunload=function(){window.ocUnloading=!0},$(document).ready((function(){$(document).trigger("render")})),$(window).on("ajaxUpdateComplete",(function(){$(document).trigger("render")})),$.fn.render=function(callback){$(document).on("render",callback)}}(window.jQuery),function(window){"use strict";function parseKey(str,pos,quote){for(var key="",i=pos;i<str.length;i++){if(quote&&quote===str[i])return key;if(!quote&&(" "===str[i]||":"===str[i]))return key;key+=str[i],"\\"===str[i]&&i+1<str.length&&(key+=str[i+1],i++)}throw new Error("Broken JSON syntax near "+key)}function getBody(str,pos){if('"'===str[pos]||"'"===str[pos]){for(var body=str[pos],i=pos+1;i<str.length;i++)if("\\"===str[i])body+=str[i],i+1<str.length&&(body+=str[i+1]),i++;else{if(str[i]===str[pos])return{originLength:(body+=str[pos]).length,body:body};body+=str[i]}throw new Error("Broken JSON string body near "+body)}if("t"===str[pos]){if(str.indexOf("true",pos)===pos)return{originLength:"true".length,body:"true"};throw new Error("Broken JSON boolean body near "+str.substr(0,pos+10))}if("f"===str[pos]){if(str.indexOf("f",pos)===pos)return{originLength:"false".length,body:"false"};throw new Error("Broken JSON boolean body near "+str.substr(0,pos+10))}if("n"===str[pos]){if(str.indexOf("null",pos)===pos)return{originLength:"null".length,body:"null"};throw new Error("Broken JSON boolean body near "+str.substr(0,pos+10))}if("-"===str[pos]||"+"===str[pos]||"."===str[pos]||str[pos]>="0"&&str[pos]<="9"){for(body="",i=pos;i<str.length;i++){if(!("-"===str[i]||"+"===str[i]||"."===str[i]||str[i]>="0"&&str[i]<="9"))return{originLength:body.length,body:body};body+=str[i]}throw new Error("Broken JSON number body near "+body)}if("{"===str[pos]||"["===str[pos]){var stack=[str[pos]];for(body=str[pos],i=pos+1;i<str.length;i++){if(body+=str[i],"\\"===str[i])i+1<str.length&&(body+=str[i+1]),i++;else if('"'===str[i])'"'===stack[stack.length-1]?stack.pop():"'"!==stack[stack.length-1]&&stack.push(str[i]);else if("'"===str[i])"'"===stack[stack.length-1]?stack.pop():'"'!==stack[stack.length-1]&&stack.push(str[i]);else if('"'!==stack[stack.length-1]&&"'"!==stack[stack.length-1])if("{"===str[i])stack.push("{");else if("}"===str[i]){if("{"!==stack[stack.length-1])throw new Error("Broken JSON "+("{"===str[pos]?"object":"array")+" body near "+body);stack.pop()}else if("["===str[i])stack.push("[");else if("]"===str[i]){if("["!==stack[stack.length-1])throw new Error("Broken JSON "+("{"===str[pos]?"object":"array")+" body near "+body);stack.pop()}if(!stack.length)return{originLength:i-pos,body:body}}throw new Error("Broken JSON "+("{"===str[pos]?"object":"array")+" body near "+body)}throw new Error("Broken JSON body near "+str.substr(pos-5>=0?pos-5:0,50))}function isBlankChar(ch){return" "===ch||"\n"===ch||"\t"===ch}function parse(str){if(!(str=str.trim()).length)throw new Error("Broken JSON object.");for(var result="";str&&","===str[0];)str=str.substr(1);if('"'===str[0]||"'"===str[0]){if(str[str.length-1]!==str[0])throw new Error("Invalid string JSON object.");for(var body='"',i=1;i<str.length;i++)if("\\"===str[i])"'"===str[i+1]||(body+=str[i]),body+=str[i+1],i++;else{if(str[i]===str[0])return body+='"';'"'===str[i]?body+='\\"':body+=str[i]}throw new Error("Invalid string JSON object.")}if("true"===str||"false"===str)return str;if("null"===str)return"null";var ch,num=parseFloat(str);if(!isNaN(num))return num.toString();if("{"===str[0]){var type="needKey";for(result="{",i=1;i<str.length;i++){if(!isBlankChar(str[i]))if("needKey"!==type||'"'!==str[i]&&"'"!==str[i]){if("needKey"===type&&("\\"!==(ch=str[i])[0]&&(ch[0]>="a"&&ch[0]<="z"||ch[0]>="A"&&ch[0]<="Z"||"_"===ch[0]||ch[0]>="0"&&ch[0]<="9"||"$"===ch[0]||ch.charCodeAt(0)>255))){var key;result+='"',result+=key=parseKey(str,i),result+='"',i+=key.length-1,type="afterKey"}else if("afterKey"===type&&":"===str[i])result+=":",type=":";else if(":"===type){i=i+(body=getBody(str,i)).originLength-1,result+=parse(body.body),type="afterBody"}else if("afterBody"===type||"needKey"===type){for(var last=i;","===str[last]||isBlankChar(str[last]);)last++;if("}"===str[last]&&last===str.length-1){for(;","===result[result.length-1];)result=result.substr(0,result.length-1);return result+="}"}last!==i&&"{"!==result&&(result+=",",type="needKey",i=last-1)}}else result+='"'+(key=parseKey(str,i+1,str[i]))+'"',i+=key.length,i+=1,type="afterKey"}throw new Error("Broken JSON object near "+result)}if("["===str[0]){for(result="[",type="needBody",i=1;i<str.length;i++)if(" "!==str[i]&&"\n"!==str[i]&&"\t"!==str[i])if("needBody"===type){if(","===str[i]){result+="null,";continue}if("]"===str[i]&&i===str.length-1)return","===result[result.length-1]&&(result=result.substr(0,result.length-1)),result+="]";i=i+(body=getBody(str,i)).originLength-1,result+=parse(body.body),type="afterBody"}else if("afterBody"===type)if(","===str[i])for(result+=",",type="needBody";","===str[i+1]||isBlankChar(str[i+1]);)","===str[i+1]&&(result+="null,"),i++;else if("]"===str[i]&&i===str.length-1)return result+="]";throw new Error("Broken JSON array near "+result)}}window.ocJSON=function(json){var jsonString=parse(json);return JSON.parse(jsonString)}}(window);
