+function($){"use strict";var Base=$.oc.foundation.base,BaseProto=Base.prototype;void 0===$.oc&&($.oc={}),void 0===$.oc.fieldRepeater&&($.oc.fieldRepeater={});var Repeater=function(element,options){this.options=options,this.$el=$(element),this.$itemContainer=$("> .field-repeater-items",this.$el),this.itemCount=0,this.canRemove=!0,this.repeaterId=$.oc.domIdManager.generate("repeater"),$.oc.foundation.controlUtils.markDisposable(element),Base.call(this),this.init()};Repeater.prototype=Object.create(BaseProto),Repeater.prototype.constructor=Repeater,Repeater.DEFAULTS={useReorder:!0,sortableHandle:".repeater-item-handle",removeHandler:"onRemoveItem",useDuplicate:!0,duplicateHandler:"onDuplicateItem",removeConfirm:"Are you sure?",displayMode:"accordion",itemsExpanded:!0,titleFrom:null,minItems:null,maxItems:null},Repeater.prototype.init=function(){this.options.useReorder&&this.bindSorting();var headSelect=this.selectorHeader;this.$el.on("change",headSelect+" input[type=checkbox]",this.proxy(this.clickItemCheckbox)),this.$el.on("click",headSelect+" .repeater-item-menu",this.proxy(this.clickItemMenu)),this.$el.on("click",headSelect+" [data-repeater-move-up]",this.proxy(this.clickMoveItemUp)),this.$el.on("click",headSelect+" [data-repeater-move-down]",this.proxy(this.clickMoveItemDown)),this.$el.on("click",headSelect+" [data-repeater-remove]",this.proxy(this.clickRemoveItem)),this.$el.on("click",headSelect+" [data-repeater-duplicate]",this.proxy(this.clickDuplicateItem)),this.$toolbar=$(this.selectorToolbar,this.$el),this.$toolbar.on("click","> [data-repeater-cmd=add-group]",this.proxy(this.clickAddGroupButton)),this.$toolbar.on("click","> [data-repeater-cmd=add]",this.proxy(this.onAddItemButton)),this.$toolbar.on("ajaxDone","> [data-repeater-cmd=add]",this.proxy(this.onAddItemSuccess)),this.$el.one("dispose-control",this.proxy(this.dispose)),this.initToolbarExtensionPoint(),this.initExternalToolbarEventBus(),this.mountExternalToolbarEventBusEvents(),this.countItems(),this.togglePrompt(),this.extendExternalToolbar()},Repeater.prototype.dispose=function(){this.options.useReorder&&this.sortable.destroy(),"builder"===this.options.displayMode?this.disposeBuilderMode():this.disposeAccordionMode();var headSelect=this.selectorHeader;this.$el.off("change",headSelect+" input[type=checkbox]",this.proxy(this.clickItemCheckbox)),this.$el.off("click",headSelect+" .repeater-item-menu",this.proxy(this.clickItemMenu)),this.$el.off("click",headSelect+" [data-repeater-move-up]",this.proxy(this.clickMoveItemUp)),this.$el.off("click",headSelect+" [data-repeater-move-down]",this.proxy(this.clickMoveItemDown)),this.$el.off("click",headSelect+" [data-repeater-remove]",this.proxy(this.clickRemoveItem)),this.$el.off("click",headSelect+" [data-repeater-duplicate]",this.proxy(this.clickDuplicateItem)),this.$toolbar.off("click","> [data-repeater-cmd=add-group]",this.proxy(this.clickAddGroupButton)),this.$toolbar.off("click","> [data-repeater-cmd=add]",this.proxy(this.onAddItemButton)),this.$toolbar.off("ajaxDone","> [data-repeater-cmd=add]",this.proxy(this.onAddItemSuccess)),this.$el.off("dispose-control",this.proxy(this.dispose)),this.$el.removeData("oc.repeater"),this.unmountExternalToolbarEventBusEvents(),this.$el=null,this.$toolbar=null,this.$sortableBody=null,this.options=null,BaseProto.dispose.call(this)},Repeater.prototype.unbind=function(){this.dispose()},Repeater.prototype.bindSorting=function(){this.$sortableBody=$(this.selectorSortable,this.$el),this.sortable=Sortable.create(this.$sortableBody.get(0),{animation:150,multiDrag:!0,avoidImplicitDeselect:!0,handle:this.options.sortableHandle,onEnd:this.proxy(this.onSortableEnd)})},Repeater.prototype.onSortableEnd=function(ev){this.eventSortableOnEnd&&this.eventSortableOnEnd()},Repeater.prototype.clickItemCheckbox=function(ev){var $target=$(ev.target),$item=$target.closest("li"),checked=$target.is(":checked");$item.toggleClass("is-checked",checked),checked?Sortable.utils.select($item.get(0)):Sortable.utils.deselect($item.get(0))},Repeater.prototype.clickItemMenu=function(ev){var templateHtml=$("> [data-item-menu-template]",this.$el).html(),$target=$(ev.target),$item=$target.closest("li"),$dropdownList=$(".dropdown-menu:first",$target.closest(".dropdown"));$dropdownList.html(templateHtml),this.eventMenuFilter($item,$dropdownList)},Repeater.prototype.clickRemoveItem=function(ev){$(ev.target).closest("li").hasClass("disabled")||this.onRemoveItem(this.findItemFromTarget(ev.target))},Repeater.prototype.onRemoveItem=function($item){var self=this,$items=this.getCheckedItemsOrItem($item),itemData=[];$.each($items,function(k,item){itemData.push({repeater_index:$(item).data("repeater-index"),repeater_group:$(item).data("repeater-group")})}),$item.request(this.options.removeHandler,{data:{_repeater_items:itemData},confirm:this.options.removeConfirm,afterUpdate:function(){self.onRemoveItemSuccess($items)}})},Repeater.prototype.onRemoveItemSuccess=function($items){var self=this;$.each($items,function(k,item){var $item=$(item);self.diposeItem($item),$item.remove(),self.eventOnRemoveItem&&self.eventOnRemoveItem($item),self.countItems(),self.triggerChange()})},Repeater.prototype.clickDuplicateItem=function(ev){this.onDuplicateItem(this.findItemFromTarget(ev.target))},Repeater.prototype.onDuplicateItem=function($item){var self=this,itemData={_repeater_index:$item.data("repeater-index"),_repeater_group:$item.data("repeater-group")};$item.request(this.options.duplicateHandler,{data:itemData,afterUpdate:function(data){self.onDuplicateItemSuccess($item,data.result.duplicateIndex)}})},Repeater.prototype.onDuplicateItemSuccess=function($item,duplicateIndex){var itemIndex=$item.data("repeater-index"),$duplicateItem=$("> li[data-repeater-index="+duplicateIndex+"]",this.$itemContainer);this.findItemFromIndex(itemIndex).after($duplicateItem),this.countItems(),this.triggerChange()},Repeater.prototype.clickMoveItemUp=function(ev){var $item=this.findItemFromTarget(ev.target);$item.prev().before($item),this.onSortableEnd()},Repeater.prototype.clickMoveItemDown=function(ev){var $item=this.findItemFromTarget(ev.target);$item.next().after($item),this.onSortableEnd()},Repeater.prototype.onAddItemButton=function(ev){this.eventOnAddItem&&this.eventOnAddItem()},Repeater.prototype.clickAddGroupButton=function(ev){var self=this,templateHtml=$("> [data-group-palette-template]",this.$el).html(),$target=$(ev.target),$form=this.$el.closest("form");$target.ocPopover({content:templateHtml});var $container=$target.data("oc.popover").$container;$container.trigger("render"),$container.on("click","a",function(ev){setTimeout(function(){$(ev.target).trigger("close.oc.popover")},1)}).on("ajaxPromise","[data-repeater-add]",function(ev,context){$target.addClass("oc-loading"),$form.one("ajaxComplete",function(){$target.removeClass("oc-loading"),self.itemCount++,self.triggerChange()}),self.eventOnAddItem&&self.eventOnAddItem()}),$("[data-repeater-add]",$container).data("request-form",$form)},Repeater.prototype.onAddItemSuccess=function(ev){this.itemCount++,this.triggerChange()},Repeater.prototype.triggerChange=function(){this.togglePrompt(),this.$el.closest("[data-field-name]").trigger("change.oc.formwidget"),this.eventOnChange&&this.eventOnChange()},Repeater.prototype.togglePrompt=function(){this.options.minItems&&this.options.minItems>0&&(this.canRemove=this.itemCount>this.options.minItems),this.options.maxItems&&this.options.maxItems>0&&this.$toolbar.toggle(this.itemCount<this.options.maxItems),$("> [data-repeater-pointer-input]:first",this.$el).attr("disabled",!!this.itemCount)},Repeater.prototype.getCollapseTitle=function($item){var $target,defaultText=this.$el.data("default-title"),explicitText=$item.data("item-title");if(explicitText)return explicitText;this.options.titleFrom?($target=$('[data-field-name="'+this.options.titleFrom+'"]',$item),$target.length||($target=$item)):$target=$item;var result="",$textInput=$("input[type=text]:first, select:first",$target).first();if($textInput.length)result=$textInput.is("select")?$textInput.find("option:selected").text():$textInput.val();else{var $disabledTextInput=$(".text-field:first > .form-control",$target);$disabledTextInput.length&&(result=$disabledTextInput.text())}return result||defaultText},Repeater.prototype.findItemFromIndex=function(itemIndex){return $("> li[data-repeater-index="+itemIndex+"]:first",this.$itemContainer)},Repeater.prototype.findItemFromTarget=function(target){return $(target).closest(".repeater-header").closest("li")},Repeater.prototype.diposeItem=function($item){$("[data-disposable]",$item).each(function(){var $el=$(this),control=$el.data("control"),widget=$el.data("oc."+control);widget&&"function"==typeof widget.dispose&&widget.dispose()})},Repeater.prototype.getCheckedItemsOrItem=function($item){var $items=this.getCheckedItems();return $items.length||($items=[$item]),$items},Repeater.prototype.getCheckedItems=function(){var $checkboxes=$(this.selectorChecked,this.$el),result=[];return $.each($checkboxes,function(k,$checkbox){result.push($checkbox.closest("li"))}),result},Repeater.prototype.countItems=function(){this.itemCount=$("> .field-repeater-item",this.$itemContainer).length,this.$el.toggleClass("repeater-empty",0===this.itemCount)},Repeater.prototype.initToolbarExtensionPoint=function(){if(this.options.externalToolbarAppState){const parts=this.options.externalToolbarAppState.split("::");if(2!==parts.length)throw new Error("Invalid externalToolbarAppState format. Expected format: module.name::stateElementName");const app=$.oc.module.import(parts[0]);this.toolbarExtensionPoint=app.state[parts[1]]}},Repeater.prototype.initExternalToolbarEventBus=function(){if(this.options.externalToolbarEventBus){const parts=this.options.externalToolbarEventBus.split("::");if(2!==parts.length)throw new Error("Invalid externalToolbarEventBus format. Expected format: module.name::stateElementName");const module=$.oc.module.import(parts[0]);this.externalToolbarEventBusObj=module.state[parts[1]]}},Repeater.prototype.mountExternalToolbarEventBusEvents=function(){this.externalToolbarEventBusObj&&(this.externalToolbarEventBusObj.$on("toolbarcmd",this.proxy(this.onToolbarExternalCommand)),this.externalToolbarEventBusObj.$on("extendapptoolbar",this.proxy(this.extendExternalToolbar)))},Repeater.prototype.unmountExternalToolbarEventBusEvents=function(){this.externalToolbarEventBusObj&&(this.externalToolbarEventBusObj.$off("toolbarcmd",this.proxy(this.onToolbarExternalCommand)),this.externalToolbarEventBusObj.$off("extendapptoolbar",this.proxy(this.extendExternalToolbar)))},Repeater.prototype.onToolbarExternalCommand=function(ev){var cmdPrefix="repeater-toolbar-";if(ev.command.substring(0,cmdPrefix.length)==cmdPrefix){if(/^repeater-toolbar-add,/.test(ev.command))return this.onAddItemClick(ev.command);var cmd=ev.command.substring(cmdPrefix.length);this.$el.find("> .field-repeater-builder > .field-repeater-toolbar, > .field-repeater-toolbar").find("[data-repeater-cmd="+cmd+"]").get(0).click(ev.ev)}},Repeater.prototype.onAddItemClick=function(cmd){var parts=cmd.split(",");if(parts[1]==this.repeaterId){var requestData=ocJSON("{"+parts[3]+"}"),that=this;this.externalToolbarEventBusObj.$emit("documentloadingstart"),this.$el.request(parts[2],{data:requestData}).always(function(){that.externalToolbarEventBusObj.$emit("documentloadingend"),that.countItems()})}},Repeater.prototype.buildAddMenuItems=function(){if(this.addMenuItems)return this.addMenuItems;var templateHtml=$("> [data-group-palette-template]",this.$el).html(),templateContainer=$(templateHtml),that=this;return this.addMenuItems=[],templateContainer.find("ul > li > a").each(function(){var $link=$(this),$icon=$link.find("i.list-icon");that.addMenuItems.push({type:"text",label:$link.find(".title").text(),icon:$icon.attr("class"),command:"repeater-toolbar-add,"+that.repeaterId+","+$link.data("request")+","+$link.data("requestData")})}),this.addMenuItems},Repeater.prototype.extendExternalToolbar=function(){if(this.$el.is(":visible")&&this.toolbarExtensionPoint){this.toolbarExtensionPoint.splice(0,this.toolbarExtensionPoint.length),this.toolbarExtensionPoint.push({type:"separator"});var that=this;this.$el.find("> .field-repeater-builder > .field-repeater-toolbar a, > .field-repeater-toolbar a").each(function(){var $button=$(this),$icon=$button.find("i[class*=icon]"),menuitems=[],isAddButton="add-group"==$button.data("repeaterCmd");menuitems=!!isAddButton&&that.buildAddMenuItems(),that.toolbarExtensionPoint.push({type:isAddButton?"dropdown":"button",icon:$icon.attr("class"),label:$button.text(),command:"repeater-toolbar-"+$button.attr("data-repeater-cmd"),disabled:void 0!==$button.attr("disabled"),menuitems:menuitems})})}};var old=$.fn.fieldRepeater;$.fn.fieldRepeater=function(option){var result,args=Array.prototype.slice.call(arguments,1);return this.each(function(){var $this=$(this),data=$this.data("oc.repeater"),options=$.extend({},Repeater.DEFAULTS,$this.data(),"object"==typeof option&&option);if(data||$this.data("oc.repeater",data=new Repeater(this,options)),"string"==typeof option&&(result=data[option].apply(data,args)),void 0!==result)return!1}),result||this},$.fn.fieldRepeater.Constructor=Repeater,$.fn.fieldRepeater.noConflict=function(){return $.fn.fieldRepeater=old,this},$(document).render(function(){$('[data-control="fieldrepeater"]').fieldRepeater()})}(window.jQuery),function($){"use strict";var RepeaterBuilder=$.fn.fieldRepeater.Constructor,overloadedInit=RepeaterBuilder.prototype.init;RepeaterBuilder.prototype.init=function(){"builder"===this.options.displayMode?(this.initBuilderMode(),overloadedInit.apply(this)):overloadedInit.apply(this)},RepeaterBuilder.prototype.initBuilderMode=function(){this.selectorToolbar="> .field-repeater-builder > .field-repeater-toolbar:first",this.selectorHeader="> .field-repeater-builder > .field-repeater-groups > .field-repeater-group > .repeater-header",this.selectorSortable="> .field-repeater-builder > .field-repeater-groups",this.selectorChecked="> .field-repeater-builder > .field-repeater-groups > .field-repeater-group > .repeater-header input[type=checkbox]:checked",this.eventSortableOnEnd=this.builderSortableOnEnd,this.eventOnChange=null,this.eventOnAddItem=this.builderOnAddItem,this.eventOnRemoveItem=this.builderOnRemoveItem,this.eventMenuFilter=this.builderMenuFilter,this.$sidebar=$("> .field-repeater-builder > .field-repeater-groups:first",this.$el),this.$sidebar.on("click","> li",this.proxy(this.clickBuilderItem)),$(document).on("render",this.proxy(this.builderOnRender)),this.transferBuilderItemHeaders(),this.selectBuilderItem()},RepeaterBuilder.prototype.disposeBuilderMode=function(){this.$sidebar=null,$(document).off("render",this.proxy(this.builderOnRender))},RepeaterBuilder.prototype.builderMenuFilter=function($item,$list){$("[data-repeater-remove]",$list).closest("li").toggleClass("disabled",!this.canRemove),$("[data-repeater-move-up]",$list).closest("li").toggle(!!$item.prev().length),$("[data-repeater-move-down]",$list).closest("li").toggle(!!$item.next().length),$("[data-repeater-expand]",$list).closest("li").hide(),$("[data-repeater-collapse]",$list).closest("li").hide()},RepeaterBuilder.prototype.builderSortableOnEnd=function(){var self=this;$("> li",this.$sidebar).each(function(){var itemIndex=$(this).data("repeater-index");self.$itemContainer.append(self.findItemFromIndex(itemIndex))})},RepeaterBuilder.prototype.builderOnRender=function(){this.transferBuilderItemHeaders()},RepeaterBuilder.prototype.builderOnAddItem=function(){var templateHtml=$("> [data-group-loading-template]",this.$el).html(),$loadingItem=$(templateHtml);this.$sidebar.append($loadingItem)},RepeaterBuilder.prototype.builderOnRemoveItem=function($item){var itemIndex=$item.data("repeater-index"),$containerItem=this.findItemFromIndex(itemIndex);this.diposeItem($containerItem),$containerItem.remove()},RepeaterBuilder.prototype.clickBuilderItem=function(ev){var $item=$(ev.target).closest(".field-repeater-group");$(ev.target).closest(".group-controls").length||this.selectBuilderItem($item.data("repeater-index"))},RepeaterBuilder.prototype.selectBuilderItem=function(itemIndex){void 0===itemIndex&&(itemIndex=$("> li:first",this.$sidebar).data("repeater-index")),$("> li.is-selected",this.$sidebar).removeClass("is-selected"),$("> li[data-repeater-index="+itemIndex+"]",this.$sidebar).addClass("is-selected"),$("> li.is-selected",this.$itemContainer).removeClass("is-selected"),$("> li[data-repeater-index="+itemIndex+"]",this.$itemContainer).addClass("is-selected"),this.setCollapsedTitles()},RepeaterBuilder.prototype.setCollapsedTitles=function(){var self=this;$("> .field-repeater-item",this.$itemContainer).each(function(){var $item=$(this),itemIndex=$item.data("repeater-index"),$groupItem=$("> li[data-repeater-index="+itemIndex+"]",self.$sidebar);$("[data-group-title]:first",$groupItem).html(self.getCollapseTitle($item))})},RepeaterBuilder.prototype.transferBuilderItemHeaders=function(){var self=this,templateHtml=$("> [data-group-template]",this.$el).html();$("> .field-repeater-item > .repeater-header",this.$itemContainer).each(function(){var $groupItem=$(templateHtml),$item=$(this).closest("li");self.$sidebar.append($groupItem),$("[data-group-controls]:first",$groupItem).replaceWith($(this).addClass("group-controls")),$("[data-group-image]:first > i",$groupItem).addClass($item.data("item-icon")),$("[data-group-title]:first",$groupItem).html($item.data("item-title")),$("[data-group-description]:first",$groupItem).html($item.data("item-description")),$groupItem.attr("data-repeater-index",$item.data("repeater-index")),$groupItem.attr("data-repeater-group",$item.data("repeater-group")),$("li.is-placeholder:first",self.$sidebar).remove(),self.selectBuilderItem($item.data("repeater-index"))})}}(window.jQuery),function($){"use strict";var RepeaterAccordion=$.fn.fieldRepeater.Constructor,overloadedInit=RepeaterAccordion.prototype.init;RepeaterAccordion.prototype.init=function(){"accordion"===this.options.displayMode?(this.initAccordionMode(),overloadedInit.apply(this),this.applyExpandedItems()):overloadedInit.apply(this)},RepeaterAccordion.prototype.initAccordionMode=function(){this.selectorToolbar="> .field-repeater-toolbar:first",this.selectorHeader="> .field-repeater-items > .field-repeater-item > .repeater-header",this.selectorSortable="> .field-repeater-items",this.selectorChecked="> .field-repeater-items > .field-repeater-item > .repeater-header input[type=checkbox]:checked",this.eventSortableOnEnd=null,this.eventOnChange=null,this.eventOnAddItem=this.accordionOnAddItem,this.eventOnRemoveItem=null,this.eventMenuFilter=this.accordionMenuFilter;var headSelect=this.selectorHeader;this.$el.on("click",headSelect,this.proxy(this.clickItemHeader)),this.$el.on("click",headSelect+" [data-repeater-expand]",this.proxy(this.toggleCollapse)),this.$el.on("click",headSelect+" [data-repeater-collapse]",this.proxy(this.toggleCollapse))},RepeaterAccordion.prototype.disposeAccordionMode=function(){var headSelect=this.selectorHeader;this.$el.off("click",headSelect,this.proxy(this.clickItemHeader)),this.$el.off("click",headSelect+" [data-repeater-expand]",this.proxy(this.toggleCollapse)),this.$el.off("click",headSelect+" [data-repeater-collapse]",this.proxy(this.toggleCollapse))},RepeaterAccordion.prototype.accordionOnAddItem=function(){this.options.itemsExpanded||this.collapseAll()},RepeaterAccordion.prototype.accordionMenuFilter=function($item,$list){$("[data-repeater-remove]",$list).closest("li").toggleClass("disabled",!this.canRemove),$("[data-repeater-move-up]",$list).closest("li").toggle(!!$item.prev().length),$("[data-repeater-move-down]",$list).closest("li").toggle(!!$item.next().length),$("[data-repeater-expand]",$list).closest("li").toggle($item.hasClass("collapsed")),$("[data-repeater-collapse]",$list).closest("li").toggle(!$item.hasClass("collapsed"))},RepeaterAccordion.prototype.clickItemHeader=function(ev){var $target=$(ev.target);if($target.hasClass("repeater-header")||$target.hasClass("repeater-item-title")||$target.hasClass("repeater-item-checkbox")){var $item=$target.closest(".field-repeater-item"),isCollapsed=$item.hasClass("collapsed");this.options.itemsExpanded||this.collapseAll(),isCollapsed?this.expand($item):this.collapse($item)}},RepeaterAccordion.prototype.applyExpandedItems=function(){if(!this.options.itemsExpanded){var items=$(this.$el).children(".field-repeater-items").children(".field-repeater-item"),self=this;$.each(items,function(key,item){self.collapse($(item))})}},RepeaterAccordion.prototype.toggleCollapse=function(ev){var self=this,$item=$(ev.target).closest(".field-repeater-item"),isCollapsed=$item.hasClass("collapsed");ev.preventDefault();var $items=this.getCheckedItemsOrItem($item);$.each($items,function(k,item){isCollapsed?self.expand($(item)):self.collapse($(item))})},RepeaterAccordion.prototype.collapseAll=function(){var self=this,$items=$("> .field-repeater-item",this.$itemContainer);$.each($items,function(key,item){self.collapse($(item))})},RepeaterAccordion.prototype.expandAll=function(){var self=this,$items=$("> .field-repeater-item",this.$itemContainer);$.each($items,function(key,item){self.expand($(item))})},RepeaterAccordion.prototype.collapse=function($item){$item.addClass("collapsed"),$("> .repeater-header > .repeater-item-title",$item).text(this.getCollapseTitle($item))},RepeaterAccordion.prototype.expand=function($item){$item.removeClass("collapsed")}}(window.jQuery);